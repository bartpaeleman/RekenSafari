<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekensafari: Verloren Dieren Avontuur!</title>
    <style>
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; text-align: center; background-color: #e6f7ff; padding: 20px; user-select: none; }
        #game-container { background: linear-gradient(to bottom, #ffe0b2, #fff3e0); border-radius: 40px; padding: 30px; max-width: 600px; margin: auto; border: 12px solid #ffcc00; box-shadow: 0 15px 0 #e6b800, 0 25px 50px rgba(0,0,0,0.15); }
        .safari-header { font-size: 2.8rem; color: #d32f2f; margin-bottom: 15px; text-shadow: 2px 2px 0 #ffeb3b; }
        .level-badge { background: #4CAF50; color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; display: inline-block; font-size: 1.3rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        #timer-container { width: 100%; height: 28px; background: #c8e6c9; border-radius: 15px; margin: 25px 0; border: 3px solid #81c784; overflow: hidden; }
        #timer-bar { width: 0%; height: 100%; background: #2e7d32; border-radius: 12px; transition: width 0.1s linear; }
        .som { font-size: 80px; margin: 15px 0; color: #333; min-height: 120px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        input { font-family: 'Comic Sans MS', sans-serif; font-size: 55px; width: 140px; text-align: center; border: 6px solid #ff9800; border-radius: 25px; outline: none; background: #fffde7; color: #e65100; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        input:focus { border-color: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.5); }
        #feedback-message { font-size: 1.8rem; color: #4CAF50; height: 35px; margin: 15px 0; font-weight: bold; }
        #animal-collection { font-size: 3rem; margin-top: 25px; min-height: 50px; word-wrap: break-word; line-height: 1.2; }
        #helper-text { font-size: 1.1rem; color: #757575; margin-top: 10px; height: 25px; }
        .focus-mode { border-color: #f44336 !important; background-color: #ffebee !important; }
        .celebration-message { color: #e65100; font-size: 1.8rem; margin-top: 15px; font-weight: bold; }

        /* Setup Screen Styles */
        #setup-container { background: white; border-radius: 40px; padding: 30px; max-width: 600px; margin: auto; border: 12px solid #4CAF50; box-shadow: 0 15px 0 #2e7d32, 0 25px 50px rgba(0,0,0,0.15); display: block; }
        #game-container { display: none; background: linear-gradient(to bottom, #ffe0b2, #fff3e0); border-radius: 40px; padding: 30px; max-width: 600px; margin: auto; border: 12px solid #ffcc00; box-shadow: 0 15px 0 #e6b800, 0 25px 50px rgba(0,0,0,0.15); }
        .setup-section { margin-bottom: 25px; }
        .setup-section h3 { color: #2e7d32; font-size: 1.5rem; margin-bottom: 10px; }
        .options-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .option-btn { background: #e8f5e9; border: 3px solid #81c784; border-radius: 15px; padding: 10px 20px; font-size: 1.2rem; cursor: pointer; font-family: inherit; color: #2e7d32; transition: all 0.2s; }
        .option-btn:hover { background: #c8e6c9; transform: translateY(-2px); }
        .option-btn.selected { background: #4CAF50; color: white; border-color: #2e7d32; box-shadow: 0 4px 0 #1b5e20; }
        #start-btn { background: #ff9800; color: white; border: none; padding: 15px 40px; font-size: 2rem; border-radius: 50px; cursor: pointer; margin-top: 20px; box-shadow: 0 6px 0 #e65100; font-family: inherit; opacity: 0.5; pointer-events: none; transition: all 0.2s; }
        #start-btn.active { opacity: 1; pointer-events: all; }
        #start-btn:active { transform: translateY(6px); box-shadow: none; }

        .config-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .config-item { background: #fffde7; padding: 10px; border-radius: 10px; border: 2px solid #ffeb3b; text-align: left; }
        .config-item label { display: block; font-weight: bold; color: #f57f17; font-size: 0.9rem; margin-bottom: 5px; }
        .config-item input { font-size: 1.2rem; width: 80px; padding: 5px; border: 2px solid #fbc02d; border-radius: 8px; text-align: center; }

        #stop-btn { position: absolute; top: 20px; right: 20px; background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #b71c1c; }
        #stop-btn:active { transform: translateY(4px); border-bottom: none; }

        #results-container { display: none; background: white; border-radius: 40px; padding: 30px; max-width: 600px; margin: auto; border: 12px solid #2196F3; box-shadow: 0 15px 0 #1976D2; }
        .stat-box { font-size: 1.5rem; margin: 15px 0; color: #333; }
        .stat-val { font-weight: bold; color: #2196F3; }
        #restart-btn { background: #2196F3; color: white; border: none; padding: 15px 40px; font-size: 1.8rem; border-radius: 50px; cursor: pointer; margin-top: 20px; box-shadow: 0 6px 0 #0d47a1; }
        #restart-btn:active { transform: translateY(6px); box-shadow: none; }
    </style>
</head>
<body>

<div id="setup-container">
    <div class="safari-header">üåç Safari Planning üó∫Ô∏è</div>

    <div class="setup-section">
        <h3>1. Kies je instellingen ‚öôÔ∏è</h3>
        <div class="config-row">
            <div class="config-item">
                <label>Tijd (sec)</label>
                <input type="number" id="cfg-time" value="10" min="3" max="60">
            </div>
            <div class="config-item">
                <label>Vragen / Level</label>
                <input type="number" id="cfg-total" value="10" min="5" max="50">
            </div>
            <div class="config-item">
                <label>Nodig goed</label>
                <input type="number" id="cfg-threshold" value="8" min="1" max="50">
            </div>
        </div>
    </div>

    <div class="setup-section">
        <h3>2. Wat wil je oefenen?</h3>
        <div class="options-grid" id="operation-options">
            <button class="option-btn" data-value="split">Splitsen</button>
            <button class="option-btn" data-value="add">Optellen</button>
            <button class="option-btn" data-value="subtract">Aftrekken</button>
            <button class="option-btn" data-value="multiply">Keer (x)</button>
            <button class="option-btn" data-value="divide">Delen (:)</button>
        </div>
    </div>
    <div class="setup-section">
        <h3>3. Tot welk level?</h3>
        <div class="options-grid" id="level-options">
            <button class="option-btn" data-value="1">1 (0-10)</button>
            <button class="option-btn" data-value="2">2 (10-20)</button>
            <button class="option-btn" data-value="3">3 (15-30)</button>
            <button class="option-btn" data-value="4">4 (20-40)</button>
            <button class="option-btn" data-value="5">5 (30-100)</button>
        </div>
    </div>
    <button id="start-btn">Start Avontuur! üöÄ</button>
</div>

<div id="results-container">
    <div class="safari-header">üèÅ Safari Afgelopen!</div>
    <div class="stat-box">Totaal gemaakt: <span id="res-total" class="stat-val">0</span></div>
    <div class="stat-box">Goed: <span id="res-correct" class="stat-val" style="color: #4CAF50">0</span></div>
    <div class="stat-box">Fout: <span id="res-wrong" class="stat-val" style="color: #d32f2f">0</span></div>
    <div class="stat-box">Dieren: <span id="res-animals"></span></div>
    <button id="restart-btn">Opnieuw Spelen üîÑ</button>
</div>

<div id="game-container">
    <button id="stop-btn">STOP üõë</button>
    <div class="safari-header">üêò Rekensafari Avontuur ü¶Å</div>
    <div id="level-indicator" class="level-badge">Begin je reis!</div>
    
    <div id="timer-container"><div id="timer-bar"></div></div>
    
    <div class="som" id="problem">Klaar voor de start?</div>
    <input type="number" id="answer" pattern="\d*" inputmode="numeric" autofocus placeholder="?">
    
    <div id="feedback-message"></div>
    <div id="helper-text"></div>
    <div id="animal-collection"></div>
    <div class="celebration-message" id="celebration-message"></div>
</div>

<script>
    let animalsFound = 0; // Total Correct answers in game
    let totalQuestionsAnswered = 0; // Total questions answered (correct + incorrect)
    let totalWrong = 0;

    let currentLevel = 1;
    let currentAnswer;
    let startTime;
    let timerInterval;
    let lastigeSommen = [];
    let sommenTeller = 0;
    const animalEmojis = ['ü¶Å', 'üêò', 'ü¶í', 'üêí', 'ü¶ì', 'üêÖ', 'üêä', 'ü¶õ'];

    // Level Progress Counters
    let levelQuestionsAnswered = 0;
    let levelCorrectAnswers = 0;

    // Settings
    let selectedOperation = null;
    let targetMaxLevel = null;
    let configTime = 10;
    let configTotalPerLevel = 10;
    let configThreshold = 8;

    // Elements
    const setupContainer = document.getElementById('setup-container');
    const gameContainer = document.getElementById('game-container');
    const resultsContainer = document.getElementById('results-container');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const restartBtn = document.getElementById('restart-btn');

    const operationOptions = document.querySelectorAll('#operation-options .option-btn');
    const levelOptions = document.querySelectorAll('#level-options .option-btn');

    const problemEl = document.getElementById('problem');
    const answerInput = document.getElementById('answer');
    const animalCollectionEl = document.getElementById('animal-collection');
    const levelIndicator = document.getElementById('level-indicator');
    const timerBar = document.getElementById('timer-bar');
    const feedbackMessageEl = document.getElementById('feedback-message');
    const helperTextEl = document.getElementById('helper-text');
    const celebrationMessageEl = document.getElementById('celebration-message');

    // Setup Logic
    function updateStartButton() {
        if (selectedOperation && targetMaxLevel) {
            startBtn.classList.add('active');
            startBtn.disabled = false;
        }
    }

    operationOptions.forEach(btn => {
        btn.addEventListener('click', () => {
            operationOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOperation = btn.dataset.value;
            updateStartButton();
        });
    });

    levelOptions.forEach(btn => {
        btn.addEventListener('click', () => {
            levelOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            targetMaxLevel = parseInt(btn.dataset.value);
            updateStartButton();
        });
    });

    startBtn.addEventListener('click', () => {
        if (!selectedOperation || !targetMaxLevel) return;

        configTime = parseInt(document.getElementById('cfg-time').value) || 10;
        configTotalPerLevel = parseInt(document.getElementById('cfg-total').value) || 10;
        configThreshold = parseInt(document.getElementById('cfg-threshold').value) || 8;

        setupContainer.style.display = 'none';
        gameContainer.style.display = 'block';

        // Reset Game State
        animalsFound = 0;
        totalQuestionsAnswered = 0;
        totalWrong = 0;
        currentLevel = 1;
        levelQuestionsAnswered = 0;
        levelCorrectAnswers = 0;
        sommenTeller = 0;
        lastigeSommen = [];
        animalCollectionEl.textContent = "";

        generateProblem();
    });

    stopBtn.addEventListener('click', () => endGame());
    restartBtn.addEventListener('click', () => {
        resultsContainer.style.display = 'none';
        setupContainer.style.display = 'block';
    });

    function endGame() {
        gameContainer.style.display = 'none';
        resultsContainer.style.display = 'block';
        clearInterval(timerInterval);

        document.getElementById('res-total').textContent = totalQuestionsAnswered;
        document.getElementById('res-correct').textContent = animalsFound;
        document.getElementById('res-wrong').textContent = totalWrong;
        document.getElementById('res-animals').textContent = animalCollectionEl.textContent;
    }

    function playSound(type) {
        let audio;
        if (type === 'correct') {
            audio = new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3');
        } else if (type === 'levelup') {
            audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
        }
        if (audio) {
            audio.volume = 0.3;
            audio.play().catch(e => console.log("Sound play error:", e));
        }
    }

    function startTimer() {
        startTime = Date.now();
        clearInterval(timerInterval);
        timerBar.style.width = '0%';
        timerBar.style.backgroundColor = '#2e7d32';
        
        const totalTimeMs = configTime * 1000;

        timerInterval = setInterval(() => {
            let elapsed = Date.now() - startTime;
            let percent = (elapsed / totalTimeMs) * 100;
            if (percent > 100) percent = 100;

            timerBar.style.width = percent + '%';
            if (percent > 70) timerBar.style.backgroundColor = '#d32f2f';
            else if (percent > 40) timerBar.style.backgroundColor = '#ffc107';
            else timerBar.style.backgroundColor = '#2e7d32';

        }, 100);
    }

    function generateProblem() {
        // Check Level Progress
        if (levelQuestionsAnswered >= configTotalPerLevel) {
            // End of Level Batch
            if (levelCorrectAnswers >= configThreshold) {
                // Passed!
                if (currentLevel < targetMaxLevel) {
                    currentLevel++;
                    showLevelUp();
                } else {
                    // Max Level Reached -> Finish Game
                    celebrationMessageEl.textContent = "GEFELICITEERD! Je bent klaar!";
                    playSound('levelup');
                    setTimeout(() => endGame(), 2500);
                }
            } else {
                // Failed -> Stay in Level
                levelQuestionsAnswered = 0;
                levelCorrectAnswers = 0;
                helperTextEl.textContent = "Bijna! Probeer het level opnieuw.";
                setTimeout(() => _generateActualProblem(), 1500);
            }
            return;
        }

        _generateActualProblem();
    }

    function showLevelUp() {
        levelQuestionsAnswered = 0;
        levelCorrectAnswers = 0;
        levelIndicator.textContent = `Level ${currentLevel}!`;
        celebrationMessageEl.textContent = "GEFELICITEERD! Volgend Level!";
        playSound('levelup');
        setTimeout(() => celebrationMessageEl.textContent = "", 3000);
        setTimeout(() => {
            _generateActualProblem();
        }, 3500);
    }

    function _generateActualProblem() {
        helperTextEl.textContent = helperTextEl.textContent || ""; // Preserve "Try again" msg if needed

        sommenTeller++;

        if (sommenTeller % 4 === 0 && lastigeSommen.length > 0) {
            let index = Math.floor(Math.random() * lastigeSommen.length);
            let gekozen = lastigeSommen[index];
            currentAnswer = gekozen.ans;
            problemEl.innerHTML = gekozen.txt;
            helperTextEl.textContent = "Oefen deze nog eens!";
            lastigeSommen.splice(index, 1);
        } else {
            // Level Definitions
            let minVal, maxVal;
            if (currentLevel === 1) { minVal=0; maxVal=10; }
            else if (currentLevel === 2) { minVal=10; maxVal=20; }
            else if (currentLevel === 3) { minVal=15; maxVal=30; }
            else if (currentLevel === 4) { minVal=20; maxVal=40; }
            else { minVal=30; maxVal=100; } // Level 5

            levelIndicator.textContent = `Level ${currentLevel} (${minVal}-${maxVal})`;
            // Random color for level badge
            const colors = ["#4CAF50", "#FF9800", "#9C27B0", "#2196F3", "#F44336"];
            levelIndicator.style.background = colors[(currentLevel - 1) % colors.length];
            
            let a, b, txt;
            let op = selectedOperation;

            problemEl.style.fontSize = "80px";

            if (op === 'split') {
                // Splitsen: Total (tot) is between min and max
                // Ensure tot >= 2 for meaningful split
                let effectiveMin = Math.max(minVal, 2);
                let tot = Math.floor(Math.random() * (maxVal - effectiveMin + 1)) + effectiveMin;
                let d1 = Math.floor(Math.random() * (tot + 1));
                currentAnswer = tot - d1;
                txt = `Splits ${tot}:<br>${d1} en ...`;
                problemEl.style.fontSize = "45px";
            } else if (op === 'add') {
                // Sum (result) between min and max
                currentAnswer = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                // a can be anything from 0 to result
                a = Math.floor(Math.random() * (currentAnswer + 1));
                b = currentAnswer - a;
                txt = `${a} + ${b} =`;
            } else if (op === 'subtract') {
                // Minuend (start number 'a') between min and max
                a = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                // b can be anything from 0 to a
                b = Math.floor(Math.random() * (a + 1));
                currentAnswer = a - b;
                txt = `${a} - ${b} =`;
            } else if (op === 'multiply') {
                 // Result between min and max
                 // Find factors.
                 let attempts = 0;
                 do {
                    a = Math.floor(Math.random() * (maxVal/2)) + 1; // Try 'a'
                    if (a === 0) a = 1;
                    // b must be such that minVal <= a*b <= maxVal
                    // b >= minVal/a  AND b <= maxVal/a
                    let minB = Math.ceil(minVal / a);
                    let maxB = Math.floor(maxVal / a);

                    if (maxB >= minB) {
                        b = Math.floor(Math.random() * (maxB - minB + 1)) + minB;
                        currentAnswer = a * b;
                        break;
                    }
                    attempts++;
                 } while (attempts < 50);

                 if (attempts >= 50) {
                     // Fallback if no valid found easily
                     a = 2; b = Math.floor(minVal/2) + 1; currentAnswer = a*b;
                 }
                 txt = `${a} x ${b} =`;

            } else if (op === 'divide') {
                // Dividend (a) between min and max
                // Find a number in range that has divisors
                let attempts = 0;
                do {
                    a = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                    if (a < 1) a = 1; // avoid 0 div?
                    // Find random divisor
                    // factors of a?
                    let factors = [];
                    for(let i=1; i<=a; i++) {
                        if (a % i === 0) factors.push(i);
                    }
                    if (factors.length > 0) {
                        b = factors[Math.floor(Math.random() * factors.length)];
                        currentAnswer = a / b;
                        break;
                    }
                    attempts++;
                } while (attempts < 50);

                if (attempts >= 50) { a=4; b=2; currentAnswer=2; }
                txt = `${a} : ${b} =`;
            }

            problemEl.innerHTML = txt;
        }

        answerInput.value = '';
        answerInput.focus();
        startTimer();
    }

    answerInput.addEventListener('input', () => {
        let val = parseInt(answerInput.value);
        if (val === currentAnswer) {
            let elapsed = Date.now() - startTime;
            clearInterval(timerInterval);
            
            animalsFound++;
            levelCorrectAnswers++;
            levelQuestionsAnswered++;
            totalQuestionsAnswered++;
            playSound('correct');

            let newAnimal = animalEmojis[Math.floor(Math.random() * animalEmojis.length)];
            let feedbackText = "Super! " + newAnimal + " gevonden!";
            // Use configTime for fast feedback
            if (elapsed < (configTime * 1000) * 0.4) {
                feedbackText = "Wauw, supersnel! " + newAnimal + " gered!";
            }
            feedbackMessageEl.textContent = feedbackText;
            animalCollectionEl.textContent += newAnimal;
            
            if (animalCollectionEl.textContent.length > 20) animalCollectionEl.textContent = animalCollectionEl.textContent.substring(2);

            setTimeout(() => {
                feedbackMessageEl.textContent = "";
                generateProblem();
            }, 600);
        } else if (answerInput.value.length >= currentAnswer.toString().length && val !== currentAnswer) {
            // Wrong answer
            levelQuestionsAnswered++;
            totalQuestionsAnswered++;
            totalWrong++;

            lastigeSommen.push({txt: problemEl.innerHTML, ans: currentAnswer});
            feedbackMessageEl.textContent = "Helaas, volgende keer beter!";
            feedbackMessageEl.style.color = "#d32f2f";
            answerInput.classList.add('focus-mode');
            setTimeout(() => { 
                answerInput.classList.remove('focus-mode'); 
                answerInput.value = ''; 
                feedbackMessageEl.textContent = "";
                feedbackMessageEl.style.color = "#4CAF50";
                generateProblem(); // Move to next problem even if wrong (to respect total questions count)
            }, 1000);
        }
    });
</script>
</body>
</html>
