<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekensafari: Verloren Dieren Avontuur!</title>
    <style>
        /* Responsive Reset & Base */
        html { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; text-align: center; background-color: #e6f7ff; margin: 0; padding: 0; user-select: none; height: 100%; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        .app-container {
            width: 95vw;
            height: 95vh;
            max-width: none;
            margin: auto;
            border-radius: 3vh;
            padding: 2vh 3vw;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto;
        }

        /* Specific Container Styles */
        #game-container {
            background: linear-gradient(to bottom, #ffe0b2, #fff3e0);
            border: 0.8vh solid #ffcc00;
            box-shadow: 0 1vh 0 #e6b800, 0 2vh 4vh rgba(0,0,0,0.15);
            display: none;
            justify-content: space-between;
        }
        #setup-container {
            background: white;
            border: 0.8vh solid #4CAF50;
            box-shadow: 0 1vh 0 #2e7d32, 0 2vh 4vh rgba(0,0,0,0.15);
            display: none;
            justify-content: center;
        }
        #results-container {
            background: white;
            border: 0.8vh solid #2196F3;
            box-shadow: 0 1vh 0 #1976D2;
            display: none;
            justify-content: center;
        }

        /* Scalable Typography & Elements */
        .safari-header { font-size: clamp(2rem, 5vh, 4rem); color: #d32f2f; margin-bottom: 2vh; text-shadow: 2px 2px 0 #ffeb3b; line-height: 1.2; flex-shrink: 0; }

        .top-bar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1vh;
            flex-shrink: 0;
        }

        .level-badge { background: #4CAF50; color: white; padding: 1vh 2vw; border-radius: 4vh; font-weight: bold; display: inline-block; font-size: clamp(1rem, 2.5vh, 2rem); box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.2); margin: 0; }

        #timer-container { width: 100%; height: 3vh; background: #c8e6c9; border-radius: 2vh; margin: 1.5vh 0; border: 0.5vh solid #81c784; overflow: hidden; flex-shrink: 0; }
        #timer-bar { width: 0%; height: 100%; background: #2e7d32; border-radius: 1.5vh; transition: width 0.1s linear; }

        .problem-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 2vw;
            flex-grow: 1; /* Allow to expand */
            min-height: 20vh;
        }

        .prestige-badge {
            font-size: clamp(2rem, 8vw, 5rem);
            min-width: 10vw;
            opacity: 0;
            transition: all 0.5s ease;
            filter: drop-shadow(0 0 10px gold);
        }
        .prestige-badge.visible {
            opacity: 1;
            transform: scale(1.2);
        }

        .som {
            font-family: Tahoma, Verdana, Arial, sans-serif;
            font-size: clamp(2.5rem, 12vw, 6rem);
            margin: 1vh 0;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1.1;
            text-shadow: 0.3vh 0.3vh 0 rgba(0,0,0,0.1);
        }

        .split-header {
            font-size: clamp(2rem, 5vh, 4rem);
            font-weight: normal;
            color: #555;
            margin: 0;
            line-height: 1;
        }

        .split-body {
            font-size: clamp(4rem, 10vh, 8rem);
            font-weight: bold;
            color: #E65100;
            margin: 0;
            line-height: 1;
        }

        input {
            font-family: 'Comic Sans MS', sans-serif;
            font-size: clamp(2.5rem, 12vw, 6rem);
            width: 30vw;
            max-width: 300px;
            text-align: center;
            border: 0.8vh solid #ff9800;
            border-radius: 2vh;
            outline: none;
            background: #fffde7;
            color: #e65100;
            box-shadow: inset 0 0.5vh 1vh rgba(0,0,0,0.1);
            margin-bottom: 1vh;
            flex-shrink: 0;
        }
        input:focus { border-color: #ff5722; box-shadow: 0 0 2vh rgba(255,87,34,0.5); }

        #feedback-message { font-size: clamp(1.5rem, 3vh, 3rem); color: #4CAF50; height: 4vh; margin: 1vh 0; font-weight: bold; flex-shrink: 0; }
        #animal-collection { font-size: clamp(2rem, 5vh, 5rem); margin-top: 2vh; min-height: 6vh; word-wrap: break-word; line-height: 1.2; flex-shrink: 0; }
        #helper-text { font-size: clamp(1rem, 2vh, 1.5rem); color: #757575; margin-top: 1vh; height: 3vh; flex-shrink: 0; }
        .focus-mode { border-color: #f44336 !important; background-color: #ffebee !important; }
        .celebration-message { color: #e65100; font-size: clamp(2rem, 4vh, 3rem); margin-top: 2vh; font-weight: bold; }

        .setup-section { margin-bottom: 3vh; flex-shrink: 0; }
        .setup-section h3 { color: #2e7d32; font-size: clamp(1.5rem, 3vh, 2.5rem); margin-bottom: 1.5vh; }
        .options-grid { display: flex; flex-wrap: wrap; gap: 1.5vh; justify-content: center; }
        .option-btn {
            background: #e8f5e9;
            border: 0.4vh solid #81c784;
            border-radius: 2vh;
            padding: 1.5vh 3vw;
            font-size: clamp(1rem, 2vh, 1.5rem);
            cursor: pointer;
            font-family: inherit;
            color: #2e7d32;
            transition: all 0.2s;
        }
        .option-btn:hover { background: #c8e6c9; transform: translateY(-0.3vh); }
        .option-btn.selected { background: #4CAF50; color: white; border-color: #2e7d32; box-shadow: 0 0.5vh 0 #1b5e20; }

        #start-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 2vh 5vw;
            font-size: clamp(1.5rem, 3vh, 3rem);
            border-radius: 4vh;
            cursor: pointer;
            margin-top: 3vh;
            box-shadow: 0 0.8vh 0 #e65100;
            font-family: inherit;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        #start-btn.active { opacity: 1; pointer-events: all; }
        #start-btn:active { transform: translateY(0.8vh); box-shadow: none; }

        /* .config-row removed in favor of direct flex in parent */
        .config-item { background: #fffde7; padding: 1vh 1vw; border-radius: 1.5vh; border: 0.3vh solid #ffeb3b; text-align: left; }
        .config-item.compact {
            flex: 1 1 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .config-item label { display: block; font-weight: bold; color: #f57f17; font-size: clamp(0.9rem, 2vh, 1.2rem); margin-bottom: 0.5vh; white-space: nowrap; }
        .config-item input, .config-item select {
            font-size: clamp(1rem, 2.5vh, 1.5rem);
            width: 100%;
            padding: 0.5vh;
            border: 0.3vh solid #fbc02d;
            border-radius: 1vh;
            text-align: center;
            box-sizing: border-box;
            background: white;
        }
        .config-desc-compact {
            font-size: clamp(0.6rem, 1.2vh, 0.9rem);
            color: #666;
            margin-top: 0.5vh;
            line-height: 1.1;
            max-height: 2.4em;
            overflow: hidden;
        }

        #stop-btn { background: #d32f2f; color: white; border: none; padding: 1.5vh 3vw; border-radius: 3vh; font-size: clamp(1rem, 2vh, 1.5rem); font-weight: bold; cursor: pointer; border-bottom: 0.5vh solid #b71c1c; }
        #stop-btn:active { transform: translateY(0.5vh); border-bottom: none; }

        #pause-btn { background: #2196F3; color: white; border: none; padding: 1.5vh 3vw; border-radius: 3vh; font-size: clamp(1rem, 2vh, 1.5rem); font-weight: bold; cursor: pointer; border-bottom: 0.5vh solid #1565C0; }
        #pause-btn:active { transform: translateY(0.5vh); border-bottom: none; }

        #pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 20; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 3vh; }
        .pause-title { font-size: clamp(3rem, 6vh, 5rem); color: #2196F3; margin-bottom: 3vh; font-weight: bold; }
        #resume-btn { background: #4CAF50; color: white; border: none; padding: 2vh 5vw; font-size: clamp(2rem, 4vh, 3rem); border-radius: 4vh; cursor: pointer; box-shadow: 0 0.8vh 0 #2e7d32; }

        #parent-save-btn { background: #673AB7; color: white; border: none; padding: 1.5vh 4vw; font-size: clamp(1rem, 2.5vh, 2rem); border-radius: 4vh; cursor: pointer; margin-top: 1vh; box-shadow: 0 0.6vh 0 #4527A0; font-family: inherit; }
        #parent-save-btn:active { transform: translateY(0.6vh); box-shadow: none; }

        #to-parent-btn { position: absolute; top: 2vh; left: 2vw; background: #ddd; border: none; padding: 1vh 1.5vw; border-radius: 1.5vh; font-size: clamp(0.8rem, 1.5vh, 1.2rem); cursor: pointer; }

        .stat-box { font-size: clamp(1.2rem, 2.5vh, 2rem); margin: 1vh 0; color: #333; }
        .stat-val { font-weight: bold; color: #2196F3; }
        #restart-btn { background: #2196F3; color: white; border: none; padding: 1.5vh 4vw; font-size: clamp(1.2rem, 2.5vh, 2rem); border-radius: 4vh; cursor: pointer; margin-top: 2vh; box-shadow: 0 0.6vh 0 #0d47a1; }
        #restart-btn:active { transform: translateY(0.6vh); box-shadow: none; }

        .badge-card {
            background: white;
            padding: 0.5vh;
            border-radius: 1vh;
            width: 100%;
            max-width: none;
            text-align: center;
            font-size: clamp(0.7rem, 1.5vh, 1rem);
            color: #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 2px solid #ccc;
            box-sizing: border-box;
        }
        .badge-card.level { border-color: #E91E63; background: #fce4ec; }
        .badge-card.session { border-color: #2196F3; background: #e3f2fd; }
        .badge-card.life { border-color: #FF9800; background: #fff3e0; }

        .badge-card .desc {
            font-size: clamp(0.6rem, 1.2vh, 0.8rem);
            color: #666;
            margin-top: 0.2vh;
            line-height: 1;
        }

        #reset-stats-btn {
            background: #ffebee;
            color: #d32f2f;
            border: 0.3vh solid #ef5350;
            padding: 1vh 2vw;
            font-size: clamp(0.8rem, 1.5vh, 1.2rem);
            border-radius: 2vh;
            cursor: pointer;
            margin-top: 1vh;
            font-family: inherit;
            align-self: center;
        }
        #reset-stats-btn:hover { background: #ffcdd2; }

        .split-container { display: flex; flex-direction: column; align-items: center; line-height: 1; }
        .split-top { margin-bottom: 0.5vh; font-weight: bold; }
        .split-legs { display: flex; gap: 4vw; color: #555; font-size: 0.5em; font-weight: normal; }
        .split-bottom { display: flex; gap: 8vw; margin-top: 0.5vh; font-weight: bold; }
        .split-sentence { font-size: 0.5em; color: #555; margin-top: 2vh; font-weight: normal; }
    </style>
</head>
<body>

<div id="parent-screen" class="app-container" style="background: white; border: 0.8vh solid #673AB7; box-shadow: 0 1vh 0 #4527A0; display: flex; flex-direction: column; justify-content: space-evenly;">
    <div class="safari-header" style="color: #673AB7; text-shadow: none; font-size: clamp(2rem, 4vh, 3rem); margin-bottom: 1vh;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Mama & Papa Scherm</div>

    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 2vw; width: 100%;">
        <!-- Settings Compact Grid -->
        <div class="config-item compact">
            <label>Naam kind</label>
            <input type="text" id="cfg-name" placeholder="Naam">
            <div class="config-desc-compact">Naam voor in het spel</div>
        </div>
        <div class="config-item compact">
            <label>Tijd (sec)</label>
            <input type="number" id="cfg-time" value="10" min="3" max="120">
            <div class="config-desc-compact">Max tijd per vraag</div>
        </div>
        <div class="config-item compact">
            <label>Vragen/Level</label>
            <input type="number" id="cfg-total" value="10" min="5" max="100">
            <div class="config-desc-compact">Minimaal aantal vragen</div>
        </div>
        <div class="config-item compact">
            <label>Drempel (%)</label>
            <input type="number" id="cfg-threshold" value="80" min="10" max="100">
            <div class="config-desc-compact">% Goed voor volgend level</div>
        </div>
        <div class="config-item compact">
            <label>Badge Niveau</label>
            <select id="cfg-badge-difficulty">
                <option value="easy">Makkelijk</option>
                <option value="normal" selected>Normaal</option>
                <option value="hard">Moeilijk</option>
            </select>
            <div class="config-desc-compact">Moeilijkheid badges</div>
        </div>
        <div class="config-item compact">
            <label>Toon Antwoord</label>
            <select id="cfg-show-correction">
                <option value="false">Nee</option>
                <option value="true">Ja</option>
            </select>
            <div class="config-desc-compact">Bij fout</div>
        </div>
        <div class="config-item compact">
            <label>Tijd Antwoord</label>
            <input type="number" id="cfg-correction-time" value="3" min="1" max="10">
            <div class="config-desc-compact">Seconden</div>
        </div>
    </div>

    <div class="setup-section" style="margin: 1vh 0; width: 100%; flex-grow: 1; overflow-y: auto;">
        <h3 style="font-size: clamp(1.2rem, 2.5vh, 2rem); margin-bottom: 1vh;">üèÜ Badges Overzicht</h3>

        <!-- Level Badges (Pink) -->
        <div style="margin-bottom: 1.5vh;">
            <div style="font-weight: bold; color: #E91E63; font-size: clamp(0.9rem, 2vh, 1.2rem); margin-bottom: 0.5vh;">Binnen 1 Level (Streak)</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vw; padding-bottom: 0.5vh;">
                <div class="badge-card level"><div>üê£ Kuiken</div><div class="desc">25% goed in level</div></div>
                <div class="badge-card level"><div>üê± Miauw</div><div class="desc">50% goed in level</div></div>
                <div class="badge-card level"><div>üê∂ Woef</div><div class="desc">75% goed in level</div></div>
                <div class="badge-card level"><div>üê∞ Konijn</div><div class="desc">Foutloos (100%)</div></div>
            </div>
        </div>

        <!-- Session Badges (Blue) -->
        <div style="margin-bottom: 1.5vh;">
            <div style="font-weight: bold; color: #2196F3; font-size: clamp(0.9rem, 2vh, 1.2rem); margin-bottom: 0.5vh;">Over Meerdere Levels</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vw; padding-bottom: 0.5vh;">
                <div class="badge-card session"><div>üêù Bij</div><div class="desc">2 levels voltooid</div></div>
                <div class="badge-card session"><div>üê≠ Muis</div><div class="desc">Snel (< 5s/vraag)</div></div>
                <div class="badge-card session"><div>üêª Beer</div><div class="desc">Level 3 bereikt</div></div>
                <div class="badge-card session"><div>ü¶ä Vos</div><div class="desc">Level 5 bereikt</div></div>
            </div>
        </div>

        <!-- Lifetime Badges (Orange) -->
        <div>
            <div style="font-weight: bold; color: #FF9800; font-size: clamp(0.9rem, 2vh, 1.2rem); margin-bottom: 0.5vh;">Levenslang (Prestatie)</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vw; padding-bottom: 0.5vh;">
                <div class="badge-card life"><div>üêº Panda</div><div class="desc">5 spellen gespeeld</div></div>
                <div class="badge-card life"><div>üêØ Tijger</div><div class="desc">100 vragen goed</div></div>
                <div class="badge-card life"><div>ü¶Å Leeuw</div><div class="desc">500 vragen goed</div></div>
                <div class="badge-card life"><div>ü¶Ñ Unicorn</div><div class="desc">1000 vragen goed</div></div>
            </div>
        </div>
    </div>

    <button id="parent-save-btn">Opslaan & Start üíæ</button>
    <button id="reset-stats-btn">Scores Wissen ‚ö†Ô∏è</button>
</div>

<div id="setup-container" class="app-container">
    <button id="to-parent-btn">Mama & Papa</button>
    <div class="safari-header" id="setup-header">We gaan samen op Safari! üåç</div>

    <div class="setup-section">
        <h3>1. Wat wil je oefenen?</h3>
        <div class="options-grid" id="operation-options">
            <button class="option-btn" data-value="split">Splitsen</button>
            <button class="option-btn" data-value="add">Optellen</button>
            <button class="option-btn" data-value="subtract">Aftrekken</button>
            <button class="option-btn" data-value="multiply">Keer (x)</button>
            <button class="option-btn" data-value="divide">Delen (:)</button>
        </div>
    </div>
    <div class="setup-section">
        <h3>2. Tot welk level?</h3>
        <div class="options-grid" id="level-options">
            <button class="option-btn" data-value="1">Level 1 (0-10)</button>
            <button class="option-btn" data-value="2">Level 2 (1-20)</button>
            <button class="option-btn" data-value="3">Level 3 (tot 100)</button>
        </div>
    </div>
    <button id="start-btn">Start Avontuur! üöÄ</button>
</div>

<div id="results-container" class="app-container">
    <div class="safari-header">Deze Safari is afgelopen! üèÅ</div>

    <div id="highest-badge-container" style="margin: 20px 0; min-height: 100px;">
        <!-- Highest badge will go here -->
    </div>

    <div id="encouragement-text" style="font-size: clamp(1.2rem, 2.5vh, 2rem); color: #E91E63; margin: 2vh 2vw; font-weight: bold; line-height: 1.3;">
        <!-- Encouraging text goes here -->
    </div>

    <div style="display: flex; gap: 4vw; justify-content: center;">
        <div class="stat-box">Totaal: <span id="res-total" class="stat-val">0</span></div>
        <div class="stat-box">Goed: <span id="res-correct" class="stat-val" style="color: #4CAF50">0</span></div>
        <div class="stat-box">Fout: <span id="res-wrong" class="stat-val" style="color: #d32f2f">0</span></div>
    </div>

    <div class="stat-box" style="margin-top: 2vh; flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
        <div id="res-animals-label" style="font-size: clamp(1rem, 2vh, 1.5rem); margin-bottom: 1vh;">Dieren:</div>
        <div id="res-animals" style="font-size: clamp(2rem, 5vh, 4rem); line-height: 1.2; word-wrap: break-word;"></div>
    </div>

    <button id="restart-btn">Opnieuw Spelen üîÑ</button>
</div>

<div id="game-container" class="app-container" style="position: relative;">
    <div id="pause-overlay">
        <div class="pause-title">Pauze ‚è∏Ô∏è</div>
        <button id="resume-btn">Verder Spelen ‚ñ∂Ô∏è</button>
    </div>

    <div id="level-start-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 25; display: none; align-items: center; justify-content: center; flex-direction: column; border-radius: 3vh;">
        <div class="safari-header" id="next-level-title">Level Klaar!</div>
        <div style="font-size: 2rem; color: #4CAF50; margin-bottom: 30px;">Goed gedaan! Klaar voor de volgende?</div>
        <button id="start-level-btn" style="background: #FF9800; color: white; border: none; padding: 2vh 5vw; font-size: clamp(2rem, 4vh, 3rem); border-radius: 4vh; cursor: pointer; box-shadow: 0 0.8vh 0 #E65100;">Start Level ‚ñ∂Ô∏è</button>
    </div>

    <div id="badge-notification" style="position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: #FFF9C4; padding: 3vh; border-radius: 3vh; border: 0.8vh solid #FFD700; box-shadow: 0 2vh 4vh rgba(0,0,0,0.3); z-index: 50; display: none; flex-direction: column; align-items: center; animation: popIn 0.5s ease; text-align: center; width: 80vw; max-width: 500px;">
        <div id="badge-notify-name" style="font-size: clamp(2rem, 5vh, 4rem); color: #E65100; font-weight: bold; margin-bottom: 1vh;">Naam</div>
        <div id="badge-notify-desc" style="font-size: clamp(1.2rem, 3vh, 2.5rem); color: #555; margin-bottom: 2vh;">Omschrijving</div>
        <div id="badge-notify-icon" style="font-size: clamp(5rem, 12vh, 10rem); filter: drop-shadow(0 0 10px gold);">üèÜ</div>
        <button id="badge-close-btn" style="background: #E65100; color: white; border: none; padding: 1.5vh 4vw; margin-top: 2vh; border-radius: 2vh; font-size: clamp(1.5rem, 3vh, 2.5rem); cursor: pointer; box-shadow: 0 0.5vh 0 #BF360C;">Sluiten ‚úñÔ∏è</button>
    </div>

    <div class="safari-header">üêò Rekensafari Avontuur ü¶Å</div>

    <div class="top-bar-controls">
        <button id="stop-btn">STOP üõë</button>
        <div id="level-indicator" class="level-badge">Begin je reis!</div>
        <button id="pause-btn">Pauze ‚è∏Ô∏è</button>
    </div>
    
    <div id="timer-container"><div id="timer-bar"></div></div>
    
    <div class="problem-row">
        <div id="prestige-left" class="prestige-badge"></div>
        <div class="som" id="problem">Klaar voor de start?</div>
        <div id="prestige-right" class="prestige-badge"></div>
    </div>

    <input type="number" id="answer" pattern="\d*" inputmode="numeric" autofocus placeholder="?">
    
    <div id="feedback-message"></div>
    <div id="helper-text"></div>
    <div id="animal-collection"></div>
    <div class="celebration-message" id="celebration-message"></div>
</div>

<script>
    let animalsFound = 0;
    let totalQuestionsAnswered = 0;
    let totalWrong = 0;

    let currentLevel = 1;
    let currentAnswer;
    let startTime;
    let timerInterval;
    let pausedTime = 0;
    let isPaused = false;
    let lastigeSommen = [];
    let sommenTeller = 0;
    let recentProblems = [];
    const MAX_RECENT_PROBLEMS = 4;
    const animalEmojis = ['ü¶Å', 'üêò', 'ü¶í', 'üêí', 'ü¶ì', 'üêÖ', 'üêä', 'ü¶õ'];

    // Level Progress Counters
    let levelQuestionsAnswered = 0;
    let levelCorrectAnswers = 0;
    let currentStreak = 0;
    let highestBadgeEarned = null; // Track best badge within session

    // Stats
    let stats = {
        totalGames: 0,
        totalCorrect: 0,
        earnedBadges: []
    };
    let sessionStats = {
        levelsCompleted: 0,
        startTime: Date.now() // For duration tracking
    };

    // Settings
    let selectedOperation = null;
    let targetMaxLevel = null;
    let configName = "";
    let configTime = 10;
    let configTotalPerLevel = 10;
    let configThreshold = 80; // Percent
    let configBadgeDifficulty = "normal"; // easy, normal, hard
    let configShowCorrection = false;
    let configCorrectionTime = 3;

    // Elements
    const parentScreen = document.getElementById('parent-screen');
    const setupContainer = document.getElementById('setup-container');
    const gameContainer = document.getElementById('game-container');
    const resultsContainer = document.getElementById('results-container');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const restartBtn = document.getElementById('restart-btn');
    const parentSaveBtn = document.getElementById('parent-save-btn');
    const toParentBtn = document.getElementById('to-parent-btn');
    const pauseOverlay = document.getElementById('pause-overlay');
    const levelStartOverlay = document.getElementById('level-start-overlay');
    const startLevelBtn = document.getElementById('start-level-btn');
    const nextLevelTitle = document.getElementById('next-level-title');

    const operationOptions = document.querySelectorAll('#operation-options .option-btn');
    const levelOptions = document.querySelectorAll('#level-options .option-btn');

    const problemEl = document.getElementById('problem');
    const prestigeLeft = document.getElementById('prestige-left');
    const prestigeRight = document.getElementById('prestige-right');
    const answerInput = document.getElementById('answer');
    const animalCollectionEl = document.getElementById('animal-collection');
    const levelIndicator = document.getElementById('level-indicator');
    const timerBar = document.getElementById('timer-bar');
    const feedbackMessageEl = document.getElementById('feedback-message');
    const helperTextEl = document.getElementById('helper-text');
    const celebrationMessageEl = document.getElementById('celebration-message');
    const badgeNotification = document.getElementById('badge-notification');

    // --- Initialization & Parent Screen ---

    function loadStats() {
        if (localStorage.getItem('safari_stats')) {
            try {
                stats = JSON.parse(localStorage.getItem('safari_stats'));
            } catch(e) { console.error("Stats load error", e); }
        }
    }

    function saveStats() {
        localStorage.setItem('safari_stats', JSON.stringify(stats));
    }

    function loadSettings() {
        if (localStorage.getItem('safari_cfg_name')) {
            configName = localStorage.getItem('safari_cfg_name');
            document.getElementById('cfg-name').value = configName;
            updatePersonalizedLabels();
        }
        if (localStorage.getItem('safari_cfg_time')) {
            document.getElementById('cfg-time').value = localStorage.getItem('safari_cfg_time');
            document.getElementById('cfg-total').value = localStorage.getItem('safari_cfg_total');
            document.getElementById('cfg-threshold').value = localStorage.getItem('safari_cfg_threshold');
        }
        if (localStorage.getItem('safari_cfg_badge_diff')) {
            configBadgeDifficulty = localStorage.getItem('safari_cfg_badge_diff');
            document.getElementById('cfg-badge-difficulty').value = configBadgeDifficulty;
        }
        if (localStorage.getItem('safari_cfg_show_correction')) {
            configShowCorrection = localStorage.getItem('safari_cfg_show_correction') === 'true';
            document.getElementById('cfg-show-correction').value = configShowCorrection;
        }
        if (localStorage.getItem('safari_cfg_correction_time')) {
            configCorrectionTime = parseInt(localStorage.getItem('safari_cfg_correction_time')) || 3;
            document.getElementById('cfg-correction-time').value = configCorrectionTime;
        }

        loadStats(); // Load badge stats
    }

    parentSaveBtn.addEventListener('click', () => {
        configName = document.getElementById('cfg-name').value.trim();
        configTime = parseInt(document.getElementById('cfg-time').value) || 10;
        configTotalPerLevel = parseInt(document.getElementById('cfg-total').value) || 10;
        configThreshold = parseInt(document.getElementById('cfg-threshold').value) || 80;
        configBadgeDifficulty = document.getElementById('cfg-badge-difficulty').value;
        configShowCorrection = document.getElementById('cfg-show-correction').value === 'true';
        configCorrectionTime = parseInt(document.getElementById('cfg-correction-time').value) || 3;

        localStorage.setItem('safari_cfg_name', configName);
        localStorage.setItem('safari_cfg_time', configTime);
        localStorage.setItem('safari_cfg_total', configTotalPerLevel);
        localStorage.setItem('safari_cfg_threshold', configThreshold);
        localStorage.setItem('safari_cfg_badge_diff', configBadgeDifficulty);
        localStorage.setItem('safari_cfg_show_correction', configShowCorrection);
        localStorage.setItem('safari_cfg_correction_time', configCorrectionTime);

        parentScreen.style.display = 'none';
        setupContainer.style.display = 'block';
        updatePersonalizedLabels();
    });

    document.getElementById('reset-stats-btn').addEventListener('click', () => {
        if (confirm("‚ö†Ô∏è Weet je zeker dat je alle scores en badges wilt wissen?\nDit kan niet ongedaan worden gemaakt!")) {
            localStorage.removeItem('safari_stats');
            stats = {
                totalGames: 0,
                totalCorrect: 0,
                earnedBadges: []
            };
            alert("Alle scores zijn gewist.");
        }
    });

    function updatePersonalizedLabels() {
        const setupHeader = document.getElementById('setup-header');
        if (configName) {
            setupHeader.textContent = `We gaan samen op Safari, ${configName}! üåç`;
        } else {
            setupHeader.textContent = "We gaan samen op Safari! üåç";
        }
    }

    toParentBtn.addEventListener('click', () => {
        setupContainer.style.display = 'none';
        parentScreen.style.display = 'block';
    });

    // --- Child Planning Screen ---

    function updateStartButton() {
        if (selectedOperation && targetMaxLevel) {
            startBtn.classList.add('active');
            startBtn.disabled = false;
        }
    }

    operationOptions.forEach(btn => {
        btn.addEventListener('click', () => {
            operationOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOperation = btn.dataset.value;
            updateStartButton();
        });
    });

    levelOptions.forEach(btn => {
        btn.addEventListener('click', () => {
            levelOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            targetMaxLevel = parseInt(btn.dataset.value);
            updateStartButton();
        });
    });

    startBtn.addEventListener('click', () => {
        if (!selectedOperation || !targetMaxLevel) return;

        setupContainer.style.display = 'none';
        gameContainer.style.display = 'block';

        // Reset Game State
        animalsFound = 0;
        totalQuestionsAnswered = 0;
        totalWrong = 0;
        currentLevel = 1;
        levelQuestionsAnswered = 0;
        levelCorrectAnswers = 0;
        currentStreak = 0;
        highestBadgeEarned = null;
        sommenTeller = 0;
        lastigeSommen = [];
        animalCollectionEl.textContent = "";
        isPaused = false;
        pauseOverlay.style.display = 'none';
        levelStartOverlay.style.display = 'none';
        celebrationMessageEl.textContent = "";

        sessionStats.levelsCompleted = 0;
        sessionStats.startTime = Date.now();

        // Check lifetime badges at start (e.g., played X games)
        stats.totalGames++;
        saveStats();
        checkBadges('game_start');
        updatePrestigeBadges();

        generateProblem();
    });

    startLevelBtn.addEventListener('click', () => {
        levelStartOverlay.style.display = 'none';
        _generateActualProblem();
    });

    // --- Game Logic ---

    stopBtn.addEventListener('click', () => endGame());

    pauseBtn.addEventListener('click', () => {
        if (!isPaused) {
            isPaused = true;
            clearInterval(timerInterval);
            // Save remaining time ratio?
            // For simplicity, we just freeze visuals.
            // Better: calculate elapsed properly on resume.
            pausedTime = Date.now();
            pauseOverlay.style.display = 'flex';
        }
    });

    resumeBtn.addEventListener('click', () => {
        if (isPaused) {
            isPaused = false;
            pauseOverlay.style.display = 'none';
            // Adjust startTime to account for pause duration
            const durationPaused = Date.now() - pausedTime;
            startTime += durationPaused;
            startTimer(false); // resume
            answerInput.focus();
        }
    });

    restartBtn.addEventListener('click', () => {
        resultsContainer.style.display = 'none';
        setupContainer.style.display = 'block';
        celebrationMessageEl.textContent = "";
    });

    function endGame() {
        gameContainer.style.display = 'none';
        resultsContainer.style.display = 'block';
        clearInterval(timerInterval);
        playSound('game_end');

        document.getElementById('res-total').textContent = totalQuestionsAnswered;
        document.getElementById('res-correct').textContent = animalsFound;
        document.getElementById('res-wrong').textContent = totalWrong;
        document.getElementById('res-animals').textContent = animalCollectionEl.textContent;

        // Personalization & High Score
        const namePart = configName ? ` ${configName}` : "";

        let labelText = `Proficiat${namePart}, je hebt deze dieren tijdens je Safari kunnen verzamelen:`;
        if (animalsFound >= 10) {
            labelText = `Fantastisch${namePart}! Je hebt een hele dierentuin verzameld:`;
        } else if (animalsFound > 0) {
            labelText = `Goed gedaan${namePart}! Deze dieren neem je mee naar huis:`;
        } else {
            labelText = `Jammer${namePart}, volgende keer vang je er vast meer!`;
        }
        document.getElementById('res-animals-label').textContent = labelText;

        const encouragementEl = document.getElementById('encouragement-text');
        const badgeContainer = document.getElementById('highest-badge-container');

        // Encouraging text logic
        let msg = "Wat heb je dat goed gedaan! Je bent een echte rekenkampioen.";
        if (totalWrong === 0 && totalQuestionsAnswered > 0) {
            msg = `Wauw${namePart}! Alles goed! Je bent superslim! üåü`;
        } else if (animalsFound > totalWrong) {
            msg = `Goed gewerkt${namePart}! Je hebt heel veel dieren gered!`;
        } else {
            msg = `Blijven oefenen${namePart}, je wordt steeds beter!`;
        }
        encouragementEl.textContent = msg;

        // Show highest badge
        if (highestBadgeEarned) {
             badgeContainer.innerHTML = `<div style="font-size: 1.5rem; margin-bottom: 10px; color: #FF9800;">Je Hoogste Level Badge:</div><div style="font-size: 8rem; filter: drop-shadow(0 0 15px gold);">${highestBadgeEarned}</div>`;
        } else {
             badgeContainer.innerHTML = "";
        }

        // Show new lifetime badges earned this session
        // (Simplified: showing total badges count or last earned)
        const earnedCount = stats.earnedBadges.length;
        if (earnedCount > 0) {
             const badgeList = document.createElement('div');
             badgeList.style.marginTop = "20px";
             badgeList.innerHTML = `<div style="font-size: 1.5rem; color: #2196F3;">Je hebt in totaal ${earnedCount} trofee√´n! üèÜ</div>`;
             badgeContainer.appendChild(badgeList);
        }
    }

    function playSound(type) {
        let audio;
        // Using existing URLs but mapping them to new logic
        if (type === 'prestige') {
            // Prestige Badge (Was LevelUp sound - distinctive bell)
            audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
        } else if (type === 'level_end') {
            // Level End (Short positive beep)
            audio = new Audio('https://www.soundjay.com/buttons/sounds/button-09.mp3');
        } else if (type === 'game_end') {
            // Game End (Celebration/Applause placeholder or reuse bell)
            audio = new Audio('https://www.soundjay.com/human/sounds/applause-01.mp3');
        }

        if (audio) {
            audio.volume = 0.2; // Low volume as requested
            audio.play().catch(e => console.log("Sound play error:", e));
        }
    }

    function startTimer(isNew = true) {
        if (isNew) startTime = Date.now();
        clearInterval(timerInterval);
        
        if (isNew) {
            timerBar.style.width = '0%';
            timerBar.style.backgroundColor = '#2e7d32';
        }

        const totalTimeMs = configTime * 1000;

        timerInterval = setInterval(() => {
            let elapsed = Date.now() - startTime;
            let percent = (elapsed / totalTimeMs) * 100;
            if (percent > 100) percent = 100;

            timerBar.style.width = percent + '%';
            if (percent > 70) timerBar.style.backgroundColor = '#d32f2f';
            else if (percent > 40) timerBar.style.backgroundColor = '#ffc107';
            else timerBar.style.backgroundColor = '#2e7d32';

        }, 100);
    }

    function generateProblem() {
        // Continuous Evaluation Logic
        // 1. Have we met the Minimum Questions requirement?
        if (levelQuestionsAnswered >= configTotalPerLevel) {

            // 2. Calculate Success Percentage
            const successRate = (levelCorrectAnswers / levelQuestionsAnswered) * 100;

            if (successRate >= configThreshold) {
                 // Level Up!
                if (currentLevel < targetMaxLevel) {
                    currentLevel++;
                    showLevelUp();
                } else {
                    celebrationMessageEl.textContent = "GEFELICITEERD! Je bent klaar!";
                    playSound('game_end');
                    setTimeout(() => endGame(), 2500);
                }
                return;
            } else {
                // Not enough success yet.
                if (levelQuestionsAnswered === configTotalPerLevel) {
                    helperTextEl.textContent = "Nog even doorzetten om het level te halen!";
                }
            }
        }

        _generateActualProblem();
    }

    function showLevelUp() {
        sessionStats.levelsCompleted++;
        checkBadges('level_complete');

        levelQuestionsAnswered = 0;
        levelCorrectAnswers = 0;
        currentStreak = 0;
        updatePrestigeBadges();

        levelIndicator.textContent = `Level ${currentLevel}!`;
        playSound('level_end');

        // Show overlay to wait for manual start
        nextLevelTitle.textContent = `Level ${currentLevel} Starten!`;
        startLevelBtn.textContent = `Start Level ${currentLevel} ‚ñ∂Ô∏è`;
        levelStartOverlay.style.display = 'flex';
    }

    // Badge Definitions
    const badges = {
        'level_chick':  { id: 'level_chick', icon: 'üê£', name: 'Beginnend Kuikentje', desc: 'Je eerste stappen gezet!', cat: 'level' },
        'level_cat':    { id: 'level_cat', icon: 'üê±', name: 'Leergierige Miauw', desc: 'Je gaat lekker vooruit!', cat: 'level' },
        'level_dog':    { id: 'level_dog', icon: 'üê∂', name: 'Doorzettende Woef', desc: 'Nog even volhouden!', cat: 'level' },
        'level_rabbit': { id: 'level_rabbit', icon: 'üê∞', name: 'Krachtig Konijn', desc: 'Alles goed! Super!', cat: 'level' },

        'session_bee':   { id: 'session_bee', icon: 'üêù', name: 'Bezige Bij', desc: 'Level 1 Voltooid!', cat: 'session' },
        'session_mouse': { id: 'session_mouse', icon: 'üê≠', name: 'Snelle Muis', desc: 'Supersnel gerekend!', cat: 'session' },
        'session_bear':  { id: 'session_bear', icon: 'üêª', name: 'Sterke Beer', desc: 'Level 2 Bereikt!', cat: 'session' },
        'session_fox':   { id: 'session_fox', icon: 'ü¶ä', name: 'Sluwe Vos', desc: 'Level 3 Bereikt!', cat: 'session' },

        'life_panda':    { id: 'life_panda', icon: 'üêº', name: 'Slimme Panda', desc: 'Al 5 keer op Safari!', cat: 'life' },
        'life_tiger':    { id: 'life_tiger', icon: 'üêØ', name: 'Perfecte Tijger', desc: '100 Vragen opgelost!', cat: 'life' },
        'life_lion':     { id: 'life_lion', icon: 'ü¶Å', name: 'Leeuwenkoning', desc: '500 Vragen! Wauw!', cat: 'life' },
        'life_unicorn':  { id: 'life_unicorn', icon: 'ü¶Ñ', name: 'Super Unicorn', desc: '1000 Vragen! Legendarisch!', cat: 'life' }
    };

    function checkBadges(context) {
        let earned = false;

        // Helper to award
        const award = (id) => {
            if (!stats.earnedBadges.includes(id)) {
                stats.earnedBadges.push(id);
                queueBadge(badges[id]);
                earned = true;
                saveStats();
            }
        };

        // Difficulty Multiplier
        let mult = 1.0;
        if (configBadgeDifficulty === 'easy') mult = 0.5;
        if (configBadgeDifficulty === 'hard') mult = 1.5;

        // Session Badges
        if (context === 'level_complete') {
            if (sessionStats.levelsCompleted >= 1) award('session_bee');
            if (currentLevel >= 2) award('session_bear');
            if (currentLevel >= 3) award('session_fox');
            if (configTime <= 5) award('session_mouse');
        }

        // Lifetime Badges
        if (context === 'game_start' || context === 'game_end') {
            if (stats.totalGames >= Math.ceil(5 * mult)) award('life_panda');
        }

        // Total Correct (Check always)
        if (stats.totalCorrect >= Math.ceil(100 * mult)) award('life_tiger');
        if (stats.totalCorrect >= Math.ceil(500 * mult)) award('life_lion');
        if (stats.totalCorrect >= Math.ceil(1000 * mult)) award('life_unicorn');

        return earned;
    }

    // Badge Queue System
    let badgeQueue = [];
    let isBadgeVisible = false;
    let badgePauseTime = 0;

    function queueBadge(badge) {
        badgeQueue.push(badge);
        processBadgeQueue();
    }

    function processBadgeQueue() {
        if (isBadgeVisible || badgeQueue.length === 0) return;

        const badge = badgeQueue.shift();
        isBadgeVisible = true;

        // Pause Game logic
        clearInterval(timerInterval);
        badgePauseTime = Date.now();

        document.getElementById('badge-notify-icon').textContent = badge.icon;
        document.getElementById('badge-notify-name').textContent = badge.name;
        document.getElementById('badge-notify-desc').textContent = badge.desc;
        badgeNotification.style.display = 'flex';
        playSound('prestige');
    }

    document.getElementById('badge-close-btn').addEventListener('click', () => {
        badgeNotification.style.display = 'none';
        isBadgeVisible = false;

        if (badgeQueue.length > 0) {
            processBadgeQueue();
        } else {
            // Resume Check
            // Only resume if we are in active game state
            const inLevelStart = levelStartOverlay.style.display === 'flex';
            const inGameEnd = resultsContainer.style.display === 'block';
            const inManualPause = pauseOverlay.style.display === 'flex';

            if (!inLevelStart && !inGameEnd && !inManualPause && gameContainer.style.display === 'block') {
                // Adjust start time to account for pause duration
                startTime += (Date.now() - badgePauseTime);
                startTimer(false);
                answerInput.focus();
            }
        }
    });

    function updatePrestigeBadges() {
        // Updates IN-GAME Level Badges (Visual only, transient)
        if (configTotalPerLevel <= 0) return false;

        // Difficulty scaling for Level Badges?
        // Prompt implies scaling. Let's scale the streak requirement effectively by changing thresholds?
        // Actually, Streak % is relative. Let's keep it simple: Fixed % for visual feedback.
        // 25, 50, 75, 100.

        let pct = (currentStreak / configTotalPerLevel) * 100;
        let badge = null;

        if (pct >= 100) badge = badges['level_rabbit'];
        else if (pct >= 75) badge = badges['level_dog'];
        else if (pct >= 50) badge = badges['level_cat'];
        else if (pct >= 25) badge = badges['level_chick'];

        let newBadge = false;

        if (badge) {
            let animal = badge.icon;
            if (prestigeLeft.textContent !== animal) {
                newBadge = true;
            }

            prestigeLeft.textContent = animal;
            prestigeRight.textContent = animal;
            prestigeLeft.classList.add('visible');
            prestigeRight.classList.add('visible');

            // Track highest session badge
            // Hierarchy: Chick < Cat < Dog < Rabbit
            const levelOrder = ['üê£', 'üê±', 'üê∂', 'üê∞'];
            if (!highestBadgeEarned || levelOrder.indexOf(animal) > levelOrder.indexOf(highestBadgeEarned)) {
                highestBadgeEarned = animal;
            }
        } else {
            prestigeLeft.classList.remove('visible');
            prestigeRight.classList.remove('visible');
            prestigeLeft.textContent = "";
            prestigeRight.textContent = "";
        }

        return newBadge;
    }

    function _generateActualProblem() {
        helperTextEl.textContent = helperTextEl.textContent || "";

        sommenTeller++;

        if (sommenTeller % 4 === 0 && lastigeSommen.length > 0) {
            let index = Math.floor(Math.random() * lastigeSommen.length);
            let gekozen = lastigeSommen[index];
            currentAnswer = gekozen.ans;
            problemEl.innerHTML = gekozen.txt;
            helperTextEl.textContent = "Oefen deze nog eens!";
            lastigeSommen.splice(index, 1);
        } else {
            // Level Definitions
            let minVal, maxVal;
            if (currentLevel === 1) { minVal=0; maxVal=10; }
            else if (currentLevel === 2) { minVal=1; maxVal=20; }
            else { minVal=1; maxVal=100; }

            levelIndicator.textContent = `Level ${currentLevel} (${minVal}-${maxVal})`;
            const colors = ["#4CAF50", "#FF9800", "#9C27B0", "#2196F3", "#F44336"];
            levelIndicator.style.background = colors[(currentLevel - 1) % colors.length];
            
            let a, b, txt, signature;
            let op = selectedOperation;
            let valid = false;
            let attempts = 0;

            do {
                attempts++;
                // problemEl.style.fontSize = "8rem"; // Removed to allow CSS responsiveness

                if (op === 'split') {
                    let effectiveMin = Math.max(minVal, 2);
                    let tot = Math.floor(Math.random() * (maxVal - effectiveMin + 1)) + effectiveMin;
                    let d1 = Math.floor(Math.random() * (tot + 1));
                    currentAnswer = tot - d1;

                    // New Tree Visualization
                    txt = `
                    <div class="split-container">
                        <div class="split-top">${tot}</div>
                        <div class="split-legs"><span>/</span><span>\\</span></div>
                        <div class="split-bottom">
                            <div>${d1}</div>
                            <div>...</div>
                        </div>
                    </div>
                    <div class="split-sentence">${tot} kan ik splitsen in ${d1} en ...</div>
                    `;
                    problemEl.style.fontSize = ""; // Allow class styling
                    signature = `split:${tot}:${d1}`;

                } else if (op === 'add') {
                    currentAnswer = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                    a = Math.floor(Math.random() * (currentAnswer + 1));
                    b = currentAnswer - a;
                    txt = `${a} + ${b} =`;
                    signature = `add:${a}:${b}`;

                } else if (op === 'subtract') {
                    a = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                    b = Math.floor(Math.random() * (a + 1));
                    currentAnswer = a - b;
                    txt = `${a} - ${b} =`;
                    signature = `sub:${a}:${b}`;

                } else if (op === 'multiply') {
                     let innerAttempts = 0;
                     do {
                        a = Math.floor(Math.random() * (maxVal/2)) + 1;
                        if (a === 0) a = 1;
                        let minB = Math.ceil(minVal / a);
                        let maxB = Math.floor(maxVal / a);
                        if (maxB >= minB) {
                            b = Math.floor(Math.random() * (maxB - minB + 1)) + minB;
                            currentAnswer = a * b;
                            break;
                        }
                        innerAttempts++;
                     } while (innerAttempts < 50);

                     if (innerAttempts >= 50) {
                         a = 2; b = Math.floor(minVal/2) + 1; currentAnswer = a*b;
                     }
                     txt = `${a} x ${b} =`;
                     signature = `mul:${a}:${b}`;

                } else if (op === 'divide') {
                    let innerAttempts = 0;
                    do {
                        a = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                        if (a < 1) a = 1;
                        let factors = [];
                        for(let i=1; i<=a; i++) {
                            if (a % i === 0) factors.push(i);
                        }
                        if (factors.length > 0) {
                            b = factors[Math.floor(Math.random() * factors.length)];
                            currentAnswer = a / b;
                            break;
                        }
                        innerAttempts++;
                    } while (innerAttempts < 50);

                    if (innerAttempts >= 50) { a=4; b=2; currentAnswer=2; }
                    txt = `${a} : ${b} =`;
                    signature = `div:${a}:${b}`;
                }

                if (!recentProblems.includes(signature)) {
                    valid = true;
                }

            } while (!valid && attempts < 10);

            recentProblems.push(signature);
            if (recentProblems.length > MAX_RECENT_PROBLEMS) {
                recentProblems.shift();
            }

            problemEl.innerHTML = txt;
        }

        answerInput.value = '';
        answerInput.focus();
        startTimer();
    }

    answerInput.addEventListener('input', () => {
        let val = parseInt(answerInput.value);
        if (val === currentAnswer) {
            let elapsed = Date.now() - startTime;
            clearInterval(timerInterval);
            
            animalsFound++;
            levelCorrectAnswers++;
            levelQuestionsAnswered++;
            totalQuestionsAnswered++;
            currentStreak++;

            stats.totalCorrect++;
            saveStats();
            checkBadges('correct_answer');

            if (updatePrestigeBadges()) {
                playSound('prestige');
            }

            const namePart = configName ? ` ${configName}` : "";
            let newAnimal = animalEmojis[Math.floor(Math.random() * animalEmojis.length)];
            let feedbackText = `Super${namePart}! ` + newAnimal + " gevonden!";
            if (elapsed < (configTime * 1000) * 0.4) {
                feedbackText = `Wauw, supersnel${namePart}! ` + newAnimal + " gered!";
            }
            feedbackMessageEl.textContent = feedbackText;
            animalCollectionEl.textContent += newAnimal;

            if (animalCollectionEl.textContent.length > 20) animalCollectionEl.textContent = animalCollectionEl.textContent.substring(2);

            setTimeout(() => {
                feedbackMessageEl.textContent = "";
                generateProblem();
            }, 600);

        } else if (answerInput.value.length >= currentAnswer.toString().length && val !== currentAnswer) {
            // Wrong answer
            levelQuestionsAnswered++;
            totalQuestionsAnswered++;
            totalWrong++;
            currentStreak = 0; // Reset streak on wrong answer
            updatePrestigeBadges();

            const namePart = configName ? ` ${configName}` : "";
            lastigeSommen.push({txt: problemEl.innerHTML, ans: currentAnswer});

            if (configShowCorrection) {
                // Show Correct Answer Logic
                feedbackMessageEl.textContent = `Helaas${namePart}, het was ${currentAnswer}!`;
                feedbackMessageEl.style.color = "#E65100"; // Orange/Warning color
                answerInput.classList.add('focus-mode');

                // Show answer in input for clarity
                answerInput.value = currentAnswer;
                answerInput.style.color = "#E65100";

                setTimeout(() => {
                    answerInput.classList.remove('focus-mode');
                    answerInput.style.color = "#e65100"; // Reset to default input color
                    answerInput.value = '';
                    feedbackMessageEl.textContent = "";
                    feedbackMessageEl.style.color = "#4CAF50";
                    generateProblem();
                }, configCorrectionTime * 1000);

            } else {
                // Original Logic
                feedbackMessageEl.textContent = `Helaas${namePart}, volgende keer beter!`;
                feedbackMessageEl.style.color = "#d32f2f";
                answerInput.classList.add('focus-mode');
                setTimeout(() => {
                    answerInput.classList.remove('focus-mode');
                    answerInput.value = '';
                    feedbackMessageEl.textContent = "";
                    feedbackMessageEl.style.color = "#4CAF50";
                    generateProblem();
                }, 1000);
            }
        }
    });

    loadSettings();
</script>
</body>
</html>
